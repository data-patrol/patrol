{%extends "master.html" %}
{%block content%}
  
<h4 class="card-title">Detailed Report</h4><br/>

<input class="form-control" id="searchInput" type="text" placeholder="Search.." style="font-size:medium">
<br/>
<table class="table table-sm table-borderless table-bordered table-hover">
    <thead class="data-table-header bg-light">
      <tr>
        <th scope="col">Check ID</th>
        <th scope="col">Status</th>
        <th scope="col">Result</th>
        <th scope="col">Severity</th>
        <th scope="col">Start Time</th>
        <th scope="col">End Time</th>
        <th scope="col">GUID</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody id="mainTable">
      {% set accumulator = namespace(curr_date="") %}
      {% for row in dq_check_runs %}
          {% if accumulator.curr_date != row.start_time.date() %}  
              {% set curr_date = row.start_time.date() %}
              {% set accumulator.curr_date = row.start_time.date() %}

              <tr class="data-table-row bg-light">
                <td colspan="8"><b>{{ accumulator.curr_date }}</b></td>
              </tr>  
          {% endif %}
      <tr class="data-table-row">
        <td>{{ row.check_id }}</th>
        <td {% if row.status == 'COMPLETED' %} class="bg-success bg-opacity-25" {% endif %}>{{ row.status }}</td>
        <td {% if row.check_id == "sql_check_1" %} class="bg-success bg-opacity-50" {%else%} class="bg-danger bg-opacity-75" {% endif %}>
          {% if row.check_id == "sql_check_1" %} PASSED
          {% elif row.check_id == "sql_check_2" %} FAILED {% endif %}
        </td>
        <td>{{ row.severity }}</td>
        <td>{{ row.start_time }}</td>
        <td>{{ row.end_time }}</td>
        <td>{{ row.guid }}-{{ row.step_seq }}</td>
        <td>
          <a class="btn btn-primary btn-sm modal-details" href="{{ url_for('check_details') }}?guid={{ row.guid }}&step={{ row.step_seq }}" role="button">Details</a>        
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  {{accumulator.total}}

  <!-- Modal: Check Details -->
  <div class="modal fade" id="modalCheckDetails" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content"></div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
  <script>
    $('.modal-details').on('click', function(event){
      event.preventDefault();
      $('#modalCheckDetails').modal('show').find('.modal-content').load($(this).attr('href'));
    });

    $(document).ready(function(){
      $("#searchInput").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#mainTable tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    });
    </script>

{% endblock %}